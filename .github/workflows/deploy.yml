name: Deploy to Production

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  deploy-production:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ§ª Run Tests
        run: npm test
        env:
          CI: true
          JWT_SECRET: test_secret
          MONGO_URI: mongodb://localhost:27017/test_db

      - name: ğŸš€ Deploy to Render
        run: |
          echo "ğŸš€ Triggering production deployment..."
          if [ -n "${{ secrets.RENDER_DEPLOY_HOOK_URL }}" ]; then
            curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK_URL }}"
            echo "âœ… Deployment triggered successfully!"
          else
            echo "âŒ RENDER_DEPLOY_HOOK_URL not configured"
            exit 1
          fi

      - name: â³ Wait for deployment
        run: |
          echo "â³ Waiting 60 seconds for deployment to complete..."
          sleep 60

      - name: âœ… Verify deployment
        run: |
          if [ -n "${{ secrets.PRODUCTION_URL }}" ]; then
            response=$(curl -s -o /dev/null -w "%{http_code}" "${{ secrets.PRODUCTION_URL }}/api/health" || echo "000")
            if [ "$response" = "200" ]; then
              echo "âœ… Health check passed! App is live."
            else
              echo "âš ï¸ Health check returned: $response"
            fi
          else
            echo "ğŸ“ Set PRODUCTION_URL secret to enable health checks"
          fi

      - name: ğŸ“ Deployment Report
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“Š DEPLOYMENT REPORT"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“… Date: $(date)"
          echo "ğŸ”– Version: ${{ github.ref_name }}"
          echo "ğŸ“ Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Triggered by: ${{ github.actor }}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
